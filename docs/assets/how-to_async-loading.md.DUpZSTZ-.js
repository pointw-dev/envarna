import{_ as i,c as a,o as n,al as e}from"./chunks/framework.DYoXd6M_.js";const c=JSON.parse('{"title":"Async loading","description":"","frontmatter":{"head":[["link",{"rel":"canonical","href":"https://pointw-dev.github.io/envarna/how-to/async-loading.html"}]]},"headers":[],"relativePath":"how-to/async-loading.md","filePath":"how-to/async-loading.md"}'),t={name:"how-to/async-loading.md"};function l(h,s,p,r,k,d){return n(),a("div",null,s[0]||(s[0]=[e(`<h1 id="async-loading" tabindex="-1">Async loading <a class="header-anchor" href="#async-loading" aria-label="Permalink to &quot;Async loading&quot;">​</a></h1><p>Many teams load settings from async sources (secrets managers, HTTP/DB lookups). Envarna keeps runtime code synchronous by resolving those values up front.</p><h2 id="class-map-proxy-override" tabindex="-1">Class-map proxy + <code>$override</code> <a class="header-anchor" href="#class-map-proxy-override" aria-label="Permalink to &quot;Class-map proxy + \`$override\`&quot;">​</a></h2><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// settings/index.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { createSettingsProxy } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;envarna&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { MongoSettings } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;./mongo&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> settings</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createSettingsProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ mongo: MongoSettings })</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> applyOverrides</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> settings.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$override</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    mongo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MongoSettings.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      s.uri </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fetchSecret</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;mongo-uri&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s.uri</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Call <code>await applyOverrides()</code> once during startup. Afterwards <code>settings.mongo.*</code> is available synchronously.</p><h2 id="lazy-vs-cached" tabindex="-1">Lazy vs cached <a class="header-anchor" href="#lazy-vs-cached" aria-label="Permalink to &quot;Lazy vs cached&quot;">​</a></h2><ul><li>Keys passed to <code>$override</code>: resolved once and cached; later reads do not consult the environment.</li><li>Keys not passed: lazy; computed on each access via <code>Class.load()</code>; reflect <code>process.env</code> changes per access.</li></ul><h2 id="readiness" tabindex="-1">Readiness <a class="header-anchor" href="#readiness" aria-label="Permalink to &quot;Readiness&quot;">​</a></h2><p>If you have async overrides, ensure they run before you access the values. Typical patterns:</p><ul><li>In an app entrypoint: <code>await applyOverrides()</code> before creating servers/workers.</li><li>In tests: call <code>applyOverrides()</code> in <code>beforeAll</code>/<code>beforeEach</code> when needed.</li></ul><p>You can also use <code>await settings.$ready()</code> if initialization happens elsewhere.</p><h2 id="json-dumps-with-async-loaders" tabindex="-1">JSON dumps with async loaders <a class="header-anchor" href="#json-dumps-with-async-loaders" aria-label="Permalink to &quot;JSON dumps with async loaders&quot;">​</a></h2><p>If any groups are initialized asynchronously and <code>$override()</code> has not run yet, calling <code>JSON.stringify(settings)</code> will throw. Ensure initialization has completed first:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> settings.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$ready</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(settings, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span></code></pre></div>`,14)]))}const g=i(t,[["render",l]]);export{c as __pageData,g as default};
